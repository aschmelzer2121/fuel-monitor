/*
 * ESP32 Fuel Flow Monitor for Outboard Motor
 * Sensor: GREDIA 3/8" Flow Sensor (B086W721V1)
 * Formula: F = 2.5 × Q (pulses per liter)
 * Bluetooth Low Energy (BLE) enabled for Android tablet
 */

#include <BLEDevice.h>
#include <BLEServer.h>
#include <BLEUtils.h>
#include <BLE2902.h>

// Pin Definitions
#define FLOW_SENSOR_PIN 4  // GPIO pin connected to flow sensor signal (yellow wire)

// BLE UUIDs
#define SERVICE_UUID        "4fafc201-1fb5-459e-8fcc-c5c9c331914b"
#define CHARACTERISTIC_UUID "beb5483e-36e1-4688-b7f5-ea07361b26a8"

// Flow Sensor Constants
#define PULSES_PER_LITER 2.5  // From sensor spec: F = 2.5 × Q
#define LITERS_TO_GALLONS 0.264172

// Variables
volatile unsigned long pulseCount = 0;
unsigned long lastTime = 0;
float flowRateLPM = 0;      // Liters per minute
float flowRateGPH = 0;      // Gallons per hour
float totalLiters = 0;      // Total fuel consumed
float totalGallons = 0;
bool deviceConnected = false;

// BLE Objects
BLEServer* pServer = NULL;
BLECharacteristic* pCharacteristic = NULL;

// Interrupt Service Routine for pulse counting
void IRAM_ATTR pulseCounter() {
  pulseCount++;
}

// BLE Server Callbacks
class MyServerCallbacks: public BLEServerCallbacks {
    void onConnect(BLEServer* pServer) {
      deviceConnected = true;
      Serial.println("Device connected");
    }

    void onDisconnect(BLEServer* pServer) {
      deviceConnected = false;
      Serial.println("Device disconnected");
      // Restart advertising
      BLEDevice::startAdvertising();
    }
};

void setup() {
  Serial.begin(115200);
  Serial.println("ESP32 Fuel Flow Monitor Starting...");
  
  // Configure flow sensor pin
  pinMode(FLOW_SENSOR_PIN, INPUT_PULLUP);
  attachInterrupt(digitalPinToInterrupt(FLOW_SENSOR_PIN), pulseCounter, FALLING);
  
  // Initialize BLE
  BLEDevice::init("Fuel Flow Monitor");
  
  // Create BLE Server
  pServer = BLEDevice::createServer();
  pServer->setCallbacks(new MyServerCallbacks());
  
  // Create BLE Service
  BLEService *pService = pServer->createService(SERVICE_UUID);
  
  // Create BLE Characteristic
  pCharacteristic = pService->createCharacteristic(
                      CHARACTERISTIC_UUID,
                      BLECharacteristic::PROPERTY_READ |
                      BLECharacteristic::PROPERTY_NOTIFY
                    );
  
  pCharacteristic->addDescriptor(new BLE2902());
  
  // Start the service
  pService->start();
  
  // Start advertising
  BLEAdvertising *pAdvertising = BLEDevice::getAdvertising();
  pAdvertising->addServiceUUID(SERVICE_UUID);
  pAdvertising->setScanResponse(true);
  pAdvertising->setMinPreferred(0x06);
  pAdvertising->setMinPreferred(0x12);
  BLEDevice::startAdvertising();
  
  Serial.println("BLE device is now advertising. Waiting for connection...");
  
  lastTime = millis();
}

void loop() {
  unsigned long currentTime = millis();
  unsigned long elapsedTime = currentTime - lastTime;
  
  // Calculate flow rate every second
  if (elapsedTime >= 1000) {
    // Disable interrupts while reading pulse count
    noInterrupts();
    unsigned long pulses = pulseCount;
    pulseCount = 0;
    interrupts();
    
    // Calculate flow rate
    // Formula: Flow (L/min) = Pulses / PULSES_PER_LITER / (elapsed_time_in_minutes)
    float timeMinutes = elapsedTime / 60000.0;
    flowRateLPM = (pulses / PULSES_PER_LITER) / timeMinutes;
    flowRateGPH = flowRateLPM * 60.0 * LITERS_TO_GALLONS;  // Convert to GPH
    
    // Update total consumption
    float litersThisPeriod = pulses / PULSES_PER_LITER;
    totalLiters += litersThisPeriod;
    totalGallons = totalLiters * LITERS_TO_GALLONS;
    
    // Debug output to Serial
    Serial.print("Flow Rate: ");
    Serial.print(flowRateGPH, 2);
    Serial.print(" GPH | Total: ");
    Serial.print(totalGallons, 2);
    Serial.println(" gal");
    
    // Send data via BLE if connected
    if (deviceConnected) {
      // Format: "GPH:12.34,TOTAL:5.67"
      String data = "GPH:" + String(flowRateGPH, 2) + 
                    ",TOTAL:" + String(totalGallons, 2);
      pCharacteristic->setValue(data.c_str());
      pCharacteristic->notify();
    }
    
    lastTime = currentTime;
  }
  
  delay(10);  // Small delay to prevent overwhelming the processor
}

// Optional: Function to reset total consumption (call via BLE command if needed)
void resetTotal() {
  totalLiters = 0;
  totalGallons = 0;
  Serial.println("Total consumption reset");
}